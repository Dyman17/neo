name: Deploy Backend to HF

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. –ö–æ–ø–∏—Ä—É–µ–º backend –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É hf-temp
      - name: Copy backend for deployment
        run: |
          rm -rf hf-temp || true
          mkdir hf-temp
          rsync -av --exclude '.git' backend/ hf-temp/

      # 3. –ö–ª–æ–Ω–∏—Ä—É–µ–º HF Space –≤ –¥—Ä—É–≥—É—é –ø–∞–ø–∫—É
      - name: Clone HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git clone https://huggingface.co/spaces/Dyman17/archaeoscan hf-space
          
      # 4. –ö–æ–ø–∏—Ä—É–µ–º backend –≤ –ø–∞–ø–∫—É HF Space
      - name: Copy backend to HF Space
        run: |
          rsync -av --delete hf-temp/ hf-space/

      # 5. –î–µ–ª–∞–µ–º –∫–æ–º–º–∏—Ç –∏ –ø—É—à
      - name: Commit and push to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cd hf-space
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Auto deploy backend from GitHub" || echo "No changes to commit"
          git push https://Dyman17:${HF_TOKEN}@huggingface.co/spaces/Dyman17/archaeoscan

      # 6. –ü–æ–ª—É—á–∞–µ–º URL Space
      - name: Get Space URL
        run: |
          echo "üöÄ Backend deployed to: https://huggingface.co/spaces/Dyman17/archaeoscan"
          echo "‚è≥ Wait 2-3 minutes for the space to rebuild..."
