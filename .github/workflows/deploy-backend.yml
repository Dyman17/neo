name: Deploy Backend to Hugging Face

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'server/**'
      - 'requirements.txt'
      - 'app.py'
      - '.github/workflows/deploy-backend.yml'
  pull_request:
    branches: [ main ]
    paths:

env:
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  HF_USERNAME: ${{ secrets.HF_USERNAME }}
  HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create Hugging Face Space files
      working-directory: ./backend
      run: |
        mkdir -p huggingface-space
        cat > huggingface-space/README.md << 'EOF'
        ---
        title: ArchaeoScan Backend
        emoji: üè∫
        colorFrom: blue
        colorTo: purple
        sdk: gradio
        sdk_version: 4.19.2
        app_file: app.py
        pinned: false
        license: mit
        ---
        
        # ArchaeoScan Backend Server
        
        WebSocket and REST API server for archaeological artifact detection and analysis.
        
        ## Features
        - Real-time WebSocket connections
        - REST API for artifacts management
        - Video recording from ESP32-CAM
        - Settings management
        - Health check endpoints
        
        ## API Endpoints
        
        ### Health Check
        - `GET /health` - Server health status
        
        ### Artifacts
        - `GET /artifacts` - Get all artifacts
        - `POST /artifacts` - Save new artifact
        - `POST /artifacts/{id}/analyze` - Analyze preservation
        
        ### Settings
        - `GET /settings` - Get settings
        - `POST /settings` - Update settings
        
        ### Video Recording
        - `POST /video/start` - Start recording
        - `POST /video/stop` - Stop recording
        - `GET /video/recordings` - Get recordings list
        
        ### WebSocket
        - `WS /ws` - Real-time artifact updates
        EOF
        
        # Copy server files
        if [ -d "server" ]; then
          cp -r server/* huggingface-space/
        fi
        
        # Copy main app file if exists
        if [ -f "app.py" ]; then
          cp app.py huggingface-space/
        fi
        
        # Copy requirements
        if [ -f "requirements.txt" ]; then
          cp requirements.txt huggingface-space/
        else
          cat > huggingface-space/requirements.txt << 'EOF'
        fastapi==0.104.1
        uvicorn[standard]==0.24.0
        websockets==12.0
        python-multipart==0.0.6
        pydantic==2.5.0
        python-dotenv==1.0.0
        aiofiles==23.2.1
        opencv-python==4.8.1.78
        numpy==1.24.3
        gradio==4.19.2
        EOF
        fi
        
    - name: Deploy to Hugging Face Space
      run: |
        python -c "
        from huggingface_hub import HfApi, Repository
        import os
        
        api = HfApi(token=os.environ['HF_TOKEN'])
        
        # Create or update space
        try:
            api.create_repo(
                repo_id=f\"{os.environ['HF_USERNAME']}/{os.environ['SPACE_NAME']}\",
                repo_type='space',
                space_sdk='gradio',
                private=False
            )
            print('Space created successfully')
        except Exception as e:
            print(f'Space might already exist: {e}')
        
        # Upload files
        api.upload_folder(
            folder_path='./huggingface-space',
            repo_id=f\"{os.environ['HF_USERNAME']}/{os.environ['SPACE_NAME']}\",
            repo_type='space',
            commit_message=f'Deploy from GitHub Actions: {os.environ['GITHUB_SHA']}'
        )
        print('Files uploaded successfully')
        "
        
    - name: Get Space URL
      run: |
        python -c "
        from huggingface_hub import HfApi
        import os
        
        api = HfApi(token=os.environ['HF_TOKEN'])
        space_info = api.repo_info(
            repo_id=f\"{os.environ['HF_USERNAME']}/{os.environ['SPACE_NAME']}\",
            repo_type='space'
        )
        
        print(f'Space URL: {space_info.url}')
        echo "SPACE_URL=${space_info.url}" >> $GITHUB_ENV
        "
        
    - name: Comment PR with deployment info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const spaceUrl = process.env.SPACE_URL || 'https://huggingface.co/spaces/' + context.repo.owner + '/' + process.env.HF_SPACE_NAME;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `üöÄ **Backend deployed to Hugging Face!**
            
            Space URL: ${spaceUrl}
            
            Commit: \`${context.sha}\`
            
            The backend server is now live and ready to serve API requests.`
          });

  test-deployment:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Wait for deployment
      run: sleep 60
      
    - name: Test health endpoint
      run: |
        SPACE_URL="https://${{ env.HF_USERNAME }}-${{ env.SPACE_NAME }}.hf.space"
        echo "Testing health endpoint at: $SPACE_URL/health"
        
        # Try to connect to health endpoint
        for i in {1..10}; do
          if curl -f "$SPACE_URL/health" > /dev/null 2>&1; then
            echo "‚úÖ Health check passed!"
            break
          else
            echo "‚è≥ Waiting for deployment to be ready... (attempt $i/10)"
            sleep 30
          fi
        done
